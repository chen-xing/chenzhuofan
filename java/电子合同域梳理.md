##  电子合同域梳理

### 1、系统架构图

![api调用架构图](D:\data\dataImages\电子合同域架构.png)

​							<!--api调用系统架构图-->

![悟空轩辕页面架构图](D:\data\dataImages\悟空页面逻辑.png)

​									<!--悟空轩辕调用系统架构图-->



### 2、流程驱动分析

#### 2.1、创建流程

> 1、当流程从草稿状态变更到执行中的状态的时候，触发流程创建，会在流程引擎创建的对应的流程节点数据
>
> 2、此时创建的流程包含此时的签名域数据



#### 2.2、添加签名域

>1、流程必须处于执行中的状态
>2、单个签名域的rank可以大于等于当前正在执行的签名域
>3、批量添加的时候rank可以大于等于当前正在执行的签名，且rank必须相同



### 3、流程引擎分析

#### 3.1、流程定义

>1、创建一个流程需要关注以下几点：流程引擎回调队列、流程节点列表
>2、流程节点包含 节点的上下文id,节点的数据、是否是起始节点、节点的网关类型、子节点列表与跳转码



#### 3.2、插入节点

>1、插入节点需要包含之前的流程id
>2、插入的节点信息
>3、节点的父节点列表
>4、节点的子节点列表



### 4、搜索引擎

#### 4.1、搜索引擎的流程分析

![搜索服务基本流程](D:\data\dataImages\搜索服务基本流程.png)



### 5、通知系统

#### 5.1、通知的流程



![通知流程](D:\data\dataImages\通知流程.png)





#### 5.2、通知分类

![通知分类](D:\data\dataImages\通知分类.png)



### 6、流程管理典型时序图



![添加节点](D:\data\dataImages\1.png)





### 7、存在的问题分析

![存在的问题](D:\data\dataImages\电子合同存在的问题.png)

> 后端广泛使用消息广播的模式来设计，一方面可以系统解耦，另一方面可以可以变相实现并发的效果
> 前端出现了一些同步调用的逻辑，所以会出现添加了节点但是节点查询不到的情况
> 解决办法是前后端统一按照异步的模式设计



> 消息队列堆积
> 搜索引擎消费过慢
> 流程归档失败



> 业务中需要区分签署执行者、签署主体、流程归属者；目前不支持
>
> 解决办法是：在扩展字段中增加流程归属的字段





### 8、部分改进意见

+ 优化系统，缩短系统的响应时间(包括各个业务系统，消息队列)
+ 前端根据情况设置一定的延时跳转策略
+ 搜索引擎的数据可根据时间。当天的数据都临时保存在缓存或者关系型数据库中，每天凌晨定时任务合并到es中
+ 归档的话可考虑消息归档或者延时归档 或者是重试归档，失败的话需要根据情况入库，后续处理
+ 去掉流程引擎依赖，流程管理服务自行实现状态机进行流转


